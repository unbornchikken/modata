"use strict";
var util = require("util");
var _ = require("lodash");
var InlineCountResult = require("./inlineCountResult");
var debug = require("debug")("modata:query");
var parseQuery = function(query, options) {
  var decodedQuery = {
    q: {},
    t: "find",
    f: false,
    s: false,
    sk: false,
    l: null,
    p: false,
    ic: false
  };
  var toJSON = function(str) {
    if (_.isString(str) && str.length > 1 && ((str[0] === "{" && str[str.length - 1] === "}") || (str[0] === "[" && str[str.length - 1] === "]"))) {
      var json = {};
      try {
        json = JSON.parse(str);
      } catch (e) {
        if (_.isString(str) && str.match(/^[$A-Z_][0-9A-Z_$]*$/i)) {
          json = str;
        } else {
          throw new TypeError("Argument is not in JSON format: " + str);
        }
      }
      return json;
    } else {
      return str;
    }
  };
  function walker(value, key, obj) {
    if (value !== null && typeof value === "object") {
      _.each(value, walker);
    } else if (typeof value === "string") {
      if (key === "$regex") {
        var m = value.match(/\/(.*)\//);
        if (m) {
          var options$__2;
          if (obj.$options) {
            m[2] = obj.$options;
            delete obj.$options;
          }
          obj[key] = new RegExp(m[1], m[2]);
        }
      }
    }
  }
  for (var key in query) {
    if (query.hasOwnProperty(key)) {
      switch (key) {
        case ("q"):
          decodedQuery.q = toJSON(decodeURIComponent(query[key]));
          _.each(decodedQuery.q, walker);
          break;
        case ("t"):
          decodedQuery.t = query[key];
          break;
        case ("f"):
          decodedQuery.f = toJSON(decodeURIComponent(query[key]));
          break;
        case ("s"):
          decodedQuery.s = toJSON(query[key]);
          break;
        case ("sk"):
          decodedQuery.sk = parseInt(query[key]);
          break;
        case ("l"):
          decodedQuery.l = parseInt(query[key]);
          break;
        case ("p"):
          decodedQuery.p = toJSON(query[key]);
          break;
        case ("ic"):
          decodedQuery.ic = (_.isString(query[key]) && query[key] === "true") || (_.isBoolean(query[key]) && query[key]);
          break;
      }
    }
  }
  return decodedQuery;
};
var doQuery = function(query, model, options, callback) {
  debug("query: %j", query);
  var parsedQuery = parseQuery(query, options);
  if (!model)
    return parsedQuery;
  debug("parsedQuery: %j", query);
  var mongooseQuery = model;
  var originalQuery = model;
  var canDoIC = false;
  var aggr = false;
  switch (parsedQuery.t) {
    case "find":
    case "count":
    case "distinct":
      canDoIC = true;
      mongooseQuery = mongooseQuery.find(parsedQuery.q);
      originalQuery = originalQuery.find(parsedQuery.q);
      break;
    case "aggregate":
    case "aggr":
      canDoIC = true;
      mongooseQuery = mongooseQuery.aggregate(parsedQuery.q);
      originalQuery = originalQuery.aggregate(parsedQuery.q);
      break;
    default:
      throw new Error("Not supported query type: '" + parsedQuery.t + "'.");
  }
  if (!aggr) {
    if (parsedQuery.t === "distinct") {
      mongooseQuery = mongooseQuery.distinct(parsedQuery.f);
    }
    if (parsedQuery.s)
      mongooseQuery = mongooseQuery.sort(parsedQuery.s);
    if (parsedQuery.sk)
      mongooseQuery = mongooseQuery.skip(parsedQuery.sk);
    if (parsedQuery.l)
      mongooseQuery = mongooseQuery.limit(parsedQuery.l);
    if (parsedQuery.f && parsedQuery.t === "find")
      mongooseQuery = mongooseQuery.select(parsedQuery.f);
    if (parsedQuery.p)
      mongooseQuery = mongooseQuery.populate(parsedQuery.p);
    if (parsedQuery.t === "count") {
      mongooseQuery = mongooseQuery.count();
    }
  } else {
    if (parsedQuery.s)
      mongooseQuery = mongooseQuery.sort(parsedQuery.s);
    if (parsedQuery.sk)
      mongooseQuery = mongooseQuery.skip(parsedQuery.sk);
    if (parsedQuery.l)
      mongooseQuery = mongooseQuery.limit(parsedQuery.l);
    if (parsedQuery.f)
      mongooseQuery = mongooseQuery.project(parsedQuery.f);
    if (parsedQuery.p) {
      throw new Error("Populate is not supported during aggregation.");
    }
  }
  if (parsedQuery.ic) {
    if (!canDoIC) {
      throw new Error("Inline count is not supported for query type: '" + parsedQuery.t + "'.");
    }
    mongooseQuery = new InlineCountResult(originalQuery, mongooseQuery, aggr);
  }
  return mongooseQuery;
};
module.exports = function Query(schema, options) {
  schema.statics.query = schema.statics.Query = function(query) {
    options = options || {};
    return doQuery(query, this, options);
  };
};
//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQywrQ0FBOEMsQ0FBQyxDQUFDO0lBQ3BFO0FBQUEsRUFDSjtBQUFBLEFBRUEsS0FBSSxXQUFVLEdBQUcsQ0FBRztBQUNoQixPQUFJLENBQUMsT0FBTSxDQUFHO0FBQ1YsVUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLGlEQUFnRCxFQUFJLENBQUEsV0FBVSxFQUFFLENBQUEsQ0FBSSxLQUFHLENBQUMsQ0FBQztJQUM3RjtBQUFBLEFBRUEsZ0JBQVksRUFBSSxJQUFJLGtCQUFnQixBQUFDLENBQUMsYUFBWSxDQUFHLGNBQVksQ0FBRyxLQUFHLENBQUMsQ0FBQztFQUM3RTtBQUFBLEFBRUEsT0FBTyxjQUFZLENBQUM7QUFDeEIsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLFNBQVMsTUFBSSxDQUFFLE1BQUssQ0FBRyxDQUFBLE9BQU0sQ0FBRztBQUM3QyxPQUFLLFFBQVEsTUFBTSxFQUFJLENBQUEsTUFBSyxRQUFRLE1BQU0sRUFBSSxVQUFVLEtBQUksQ0FBRztBQUMzRCxVQUFNLEVBQUksQ0FBQSxPQUFNLEdBQUssR0FBQyxDQUFDO0FBQ3ZCLFNBQU8sQ0FBQSxPQUFNLEFBQUMsQ0FBQyxLQUFJLENBQUcsS0FBRyxDQUFHLFFBQU0sQ0FBQyxDQUFDO0VBQ3hDLENBQUM7QUFDTCxDQUFDO0FBQ0QiLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5sZXQgSW5saW5lQ291bnRSZXN1bHQgPSByZXF1aXJlKFwiLi9pbmxpbmVDb3VudFJlc3VsdFwiKTtcclxubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwibW9kYXRhOnF1ZXJ5XCIpO1xyXG5cclxubGV0IHBhcnNlUXVlcnkgPSBmdW5jdGlvbiAocXVlcnksIG9wdGlvbnMpIHtcclxuICAgIGxldCBkZWNvZGVkUXVlcnkgPSB7XHJcbiAgICAgICAgcToge30sICAgICAgLy8gIHF1ZXJ5XHJcbiAgICAgICAgdDogXCJmaW5kXCIsICAgLy8gIGNvdW50XHJcbiAgICAgICAgZjogZmFsc2UsICAgICAgLy8gZmllbGRzXHJcbiAgICAgICAgczogZmFsc2UsICAgICAgLy8gIHNvcnRcclxuICAgICAgICBzazogZmFsc2UsICAgICAgLy8gIHNraXBcclxuICAgICAgICBsOiBudWxsLCAgICAgLy8gIGxpbWl0XHJcbiAgICAgICAgcDogZmFsc2UsICAgIC8vcG9wdWxhdGVcclxuICAgICAgICBpYzogZmFsc2VcclxuICAgIH07XHJcblxyXG4gICAgbGV0IHRvSlNPTiA9IGZ1bmN0aW9uIChzdHIpIHtcclxuICAgICAgICBpZiAoXy5pc1N0cmluZyhzdHIpICYmIHN0ci5sZW5ndGggPiAxICYmXHJcbiAgICAgICAgICAgICgoc3RyWzBdID09PSBcIntcIiAmJiBzdHJbc3RyLmxlbmd0aCAtIDFdID09PSBcIn1cIikgfHxcclxuICAgICAgICAgICAgKHN0clswXSA9PT0gXCJbXCIgJiYgc3RyW3N0ci5sZW5ndGggLSAxXSA9PT0gXCJdXCIpKSkge1xyXG4gICAgICAgICAgICBsZXQganNvbiA9IHt9O1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAganNvbiA9IEpTT04ucGFyc2Uoc3RyKTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKF8uaXNTdHJpbmcoc3RyKSAmJiBzdHIubWF0Y2goL15bJEEtWl9dWzAtOUEtWl8kXSokL2kpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAganNvbiA9IHN0cjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCBpcyBub3QgaW4gSlNPTiBmb3JtYXQ6IFwiICsgc3RyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4ganNvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzdHI7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBmdW5jdGlvbiB3YWxrZXIodmFsdWUsIGtleSwgb2JqKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICAvLyBSZWN1cnNlIGludG8gY2hpbGRyZW5cclxuICAgICAgICAgICAgXy5lYWNoKHZhbHVlLCB3YWxrZXIpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgICAgIGlmIChrZXkgPT09IFwiJHJlZ2V4XCIpIHtcclxuICAgICAgICAgICAgICAgIGxldCBtID0gdmFsdWUubWF0Y2goL1xcLyguKilcXC8vKTtcclxuICAgICAgICAgICAgICAgIGlmIChtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai4kb3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtWzJdID0gb2JqLiRvcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb2JqLiRvcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IG5ldyBSZWdFeHAobVsxXSwgbVsyXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChsZXQga2V5IGluIHF1ZXJ5KSB7XHJcbiAgICAgICAgaWYgKHF1ZXJ5Lmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgICAgICAgc3dpdGNoIChrZXkpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UoXCJxXCIpOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlY29kZWRRdWVyeS5xID0gdG9KU09OKGRlY29kZVVSSUNvbXBvbmVudChxdWVyeVtrZXldKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGRlY29kZWRRdWVyeS5xLCB3YWxrZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcInRcIik6XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZFF1ZXJ5LnQgPSBxdWVyeVtrZXldO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcImZcIik6XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZFF1ZXJ5LmYgPSB0b0pTT04oZGVjb2RlVVJJQ29tcG9uZW50KHF1ZXJ5W2tleV0pKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UoXCJzXCIpOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlY29kZWRRdWVyeS5zID0gdG9KU09OKHF1ZXJ5W2tleV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcInNrXCIpOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlY29kZWRRdWVyeS5zayA9IHBhcnNlSW50KHF1ZXJ5W2tleV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcImxcIik6XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZFF1ZXJ5LmwgPSBwYXJzZUludChxdWVyeVtrZXldKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UoXCJwXCIpOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlY29kZWRRdWVyeS5wID0gdG9KU09OKHF1ZXJ5W2tleV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcImljXCIpOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlY29kZWRRdWVyeS5pYyA9IChfLmlzU3RyaW5nKHF1ZXJ5W2tleV0pICYmIHF1ZXJ5W2tleV0gPT09IFwidHJ1ZVwiKSB8fCAoXy5pc0Jvb2xlYW4ocXVlcnlba2V5XSkgJiYgcXVlcnlba2V5XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGVjb2RlZFF1ZXJ5O1xyXG59O1xyXG5cclxubGV0IGRvUXVlcnkgPSBmdW5jdGlvbiAocXVlcnksIG1vZGVsLCBvcHRpb25zLCBjYWxsYmFjaykge1xyXG4gICAgZGVidWcoXCJxdWVyeTogJWpcIiwgcXVlcnkpO1xyXG4gICAgbGV0IHBhcnNlZFF1ZXJ5ID0gcGFyc2VRdWVyeShxdWVyeSwgb3B0aW9ucyk7XHJcbiAgICBpZiAoIW1vZGVsKXJldHVybiBwYXJzZWRRdWVyeTtcclxuICAgIGRlYnVnKFwicGFyc2VkUXVlcnk6ICVqXCIsIHF1ZXJ5KTtcclxuICAgIGxldCBtb25nb29zZVF1ZXJ5ID0gbW9kZWw7XHJcbiAgICBsZXQgb3JpZ2luYWxRdWVyeSA9IG1vZGVsO1xyXG5cclxuICAgIGxldCBjYW5Eb0lDID0gZmFsc2U7XHJcbiAgICBsZXQgYWdnciA9IGZhbHNlO1xyXG5cclxuICAgIHN3aXRjaCAocGFyc2VkUXVlcnkudCkge1xyXG4gICAgICAgIGNhc2UgXCJmaW5kXCI6XHJcbiAgICAgICAgY2FzZSBcImNvdW50XCI6XHJcbiAgICAgICAgY2FzZSBcImRpc3RpbmN0XCI6XHJcbiAgICAgICAgICAgIGNhbkRvSUMgPSB0cnVlO1xyXG4gICAgICAgICAgICBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5maW5kKHBhcnNlZFF1ZXJ5LnEpO1xyXG4gICAgICAgICAgICBvcmlnaW5hbFF1ZXJ5ID0gb3JpZ2luYWxRdWVyeS5maW5kKHBhcnNlZFF1ZXJ5LnEpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIFwiYWdncmVnYXRlXCI6XHJcbiAgICAgICAgY2FzZSBcImFnZ3JcIjpcclxuICAgICAgICAgICAgY2FuRG9JQyA9IHRydWU7XHJcbiAgICAgICAgICAgIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LmFnZ3JlZ2F0ZShwYXJzZWRRdWVyeS5xKTtcclxuICAgICAgICAgICAgb3JpZ2luYWxRdWVyeSA9IG9yaWdpbmFsUXVlcnkuYWdncmVnYXRlKHBhcnNlZFF1ZXJ5LnEpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJOb3Qgc3VwcG9ydGVkIHF1ZXJ5IHR5cGU6ICdcIiArIHBhcnNlZFF1ZXJ5LnQgKyBcIicuXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghYWdncikge1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS50ID09PSBcImRpc3RpbmN0XCIpIHtcclxuICAgICAgICAgICAgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuZGlzdGluY3QocGFyc2VkUXVlcnkuZik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS5zKSBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5zb3J0KHBhcnNlZFF1ZXJ5LnMpO1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS5zaykgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuc2tpcChwYXJzZWRRdWVyeS5zayk7XHJcbiAgICAgICAgaWYgKHBhcnNlZFF1ZXJ5LmwpIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LmxpbWl0KHBhcnNlZFF1ZXJ5LmwpO1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS5mICYmIHBhcnNlZFF1ZXJ5LnQgPT09IFwiZmluZFwiKSBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5zZWxlY3QocGFyc2VkUXVlcnkuZik7XHJcbiAgICAgICAgaWYgKHBhcnNlZFF1ZXJ5LnApIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LnBvcHVsYXRlKHBhcnNlZFF1ZXJ5LnApO1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS50ID09PSBcImNvdW50XCIpIHtcclxuICAgICAgICAgICAgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuY291bnQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkucykgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuc29ydChwYXJzZWRRdWVyeS5zKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkuc2spIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LnNraXAocGFyc2VkUXVlcnkuc2spO1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS5sKSBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5saW1pdChwYXJzZWRRdWVyeS5sKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkuZikgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkucHJvamVjdChwYXJzZWRRdWVyeS5mKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkucCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQb3B1bGF0ZSBpcyBub3Qgc3VwcG9ydGVkIGR1cmluZyBhZ2dyZWdhdGlvbi5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChwYXJzZWRRdWVyeS5pYykge1xyXG4gICAgICAgIGlmICghY2FuRG9JQykge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbmxpbmUgY291bnQgaXMgbm90IHN1cHBvcnRlZCBmb3IgcXVlcnkgdHlwZTogJ1wiICsgcGFyc2VkUXVlcnkudCArIFwiJy5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIERvIGlubGluZSBjb3VudDpcclxuICAgICAgICBtb25nb29zZVF1ZXJ5ID0gbmV3IElubGluZUNvdW50UmVzdWx0KG9yaWdpbmFsUXVlcnksIG1vbmdvb3NlUXVlcnksIGFnZ3IpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtb25nb29zZVF1ZXJ5O1xyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBRdWVyeShzY2hlbWEsIG9wdGlvbnMpIHtcclxuICAgIHNjaGVtYS5zdGF0aWNzLnF1ZXJ5ID0gc2NoZW1hLnN0YXRpY3MuUXVlcnkgPSBmdW5jdGlvbiAocXVlcnkpIHtcclxuICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcclxuICAgICAgICByZXR1cm4gZG9RdWVyeShxdWVyeSwgdGhpcywgb3B0aW9ucyk7XHJcbiAgICB9O1xyXG59O1xyXG4iXX0=
