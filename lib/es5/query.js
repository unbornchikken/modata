"use strict";
var util = require("util");
var _ = require("lodash");
var InlineCountResult = require("./inlineCountResult");
var debug = require("debug")("modata:query");
var parseQuery = function(query, options) {
  var decodedQuery = {
    q: {},
    t: "find",
    f: false,
    s: false,
    sk: false,
    l: null,
    p: false,
    ic: false
  };
  var decode = function(value) {
    var to = function(str) {
      str = str.trim();
      if ((str.length > 1) && ((str[0] === "{" && str[str.length - 1] === "}") || (str[0] === "'" && str[str.length - 1] === "'") || (str[0] === '"' && str[str.length - 1] === '"') || (str[0] === "[" && str[str.length - 1] === "]"))) {
        try {
          return JSON.parse(str);
        } catch (e) {
          _.noop(e);
        }
      }
      return false;
    };
    if (_.isString(value)) {
      var result = to(value);
      if (result === false) {
        result = to(decodeURIComponent(value));
      }
      if (result === false) {
        return value;
      }
      return result;
    }
    return value;
  };
  function walker(value, key, obj) {
    if (!value) {
      return;
    }
    if (_.isArray(value) || _.isPlainObject(value)) {
      _.forEach(value, walker);
    } else if (_.isString(value)) {
      if (key === "$regex") {
        var m = value.match(/\/(.*)\//);
        if (m) {
          var options$__2;
          if (obj.$options) {
            m[2] = obj.$options;
            delete obj.$options;
          }
          obj[key] = new RegExp(m[1], m[2]);
        }
      } else {
        var decoded = decode(value);
        if (decoded !== value) {
          obj[key] = decoded;
          walker(decoded, key, obj);
        }
      }
    }
  }
  for (var key in query) {
    if (query.hasOwnProperty(key)) {
      switch (key) {
        case ("q"):
          decodedQuery.q = decode(query[key]);
          _.each(decodedQuery.q, walker);
          break;
        case ("t"):
          decodedQuery.t = query[key];
          break;
        case ("f"):
          decodedQuery.f = decode(query[key]);
          break;
        case ("s"):
          decodedQuery.s = decode(query[key]);
          break;
        case ("sk"):
          decodedQuery.sk = parseInt(query[key]);
          break;
        case ("l"):
          decodedQuery.l = parseInt(query[key]);
          break;
        case ("p"):
          decodedQuery.p = decode(query[key]);
          break;
        case ("ic"):
          decodedQuery.ic = (_.isString(query[key]) && query[key] === "true") || (_.isBoolean(query[key]) && query[key]);
          break;
      }
    }
  }
  return decodedQuery;
};
var doQuery = function(query, model, options, callback) {
  debug("query: %j", query);
  var parsedQuery = parseQuery(query, options);
  if (!model)
    return parsedQuery;
  debug("parsedQuery: %j", query);
  var mongooseQuery = model;
  var originalQuery = model;
  var canDoIC = false;
  var aggr = false;
  switch (parsedQuery.t) {
    case "find":
    case "count":
    case "distinct":
      canDoIC = true;
      mongooseQuery = mongooseQuery.find(parsedQuery.q);
      originalQuery = originalQuery.find(parsedQuery.q);
      break;
    case "aggregate":
    case "aggr":
      canDoIC = true;
      mongooseQuery = mongooseQuery.aggregate(parsedQuery.q);
      originalQuery = originalQuery.aggregate(parsedQuery.q);
      break;
    default:
      throw new Error("Not supported query type: '" + parsedQuery.t + "'.");
  }
  if (!aggr) {
    if (parsedQuery.t === "distinct") {
      mongooseQuery = mongooseQuery.distinct(parsedQuery.f);
    }
    if (parsedQuery.s)
      mongooseQuery = mongooseQuery.sort(parsedQuery.s);
    if (parsedQuery.sk)
      mongooseQuery = mongooseQuery.skip(parsedQuery.sk);
    if (parsedQuery.l)
      mongooseQuery = mongooseQuery.limit(parsedQuery.l);
    if (parsedQuery.f && parsedQuery.t === "find")
      mongooseQuery = mongooseQuery.select(parsedQuery.f);
    if (parsedQuery.p)
      mongooseQuery = mongooseQuery.populate(parsedQuery.p);
    if (parsedQuery.t === "count") {
      mongooseQuery = mongooseQuery.count();
    }
  } else {
    if (parsedQuery.s)
      mongooseQuery = mongooseQuery.sort(parsedQuery.s);
    if (parsedQuery.sk)
      mongooseQuery = mongooseQuery.skip(parsedQuery.sk);
    if (parsedQuery.l)
      mongooseQuery = mongooseQuery.limit(parsedQuery.l);
    if (parsedQuery.f)
      mongooseQuery = mongooseQuery.project(parsedQuery.f);
    if (parsedQuery.p) {
      throw new Error("Populate is not supported during aggregation.");
    }
  }
  if (parsedQuery.ic) {
    if (!canDoIC) {
      throw new Error("Inline count is not supported for query type: '" + parsedQuery.t + "'.");
    }
    mongooseQuery = new InlineCountResult(originalQuery, mongooseQuery, aggr);
  }
  return mongooseQuery;
};
module.exports = function Query(schema, options) {
  schema.statics.query = schema.statics.Query = function(query) {
    options = options || {};
    return doQuery(query, this, options);
  };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInF1ZXJ5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBRUEsQUFBSSxFQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7QUFDMUIsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsaUJBQWdCLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxxQkFBb0IsQ0FBQyxDQUFDO0FBQ3RELEFBQUksRUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE9BQU0sQ0FBQyxBQUFDLENBQUMsY0FBYSxDQUFDLENBQUM7QUFFNUMsQUFBSSxFQUFBLENBQUEsVUFBUyxFQUFJLFVBQVUsS0FBSSxDQUFHLENBQUEsT0FBTSxDQUFHO0FBQ3ZDLEFBQUksSUFBQSxDQUFBLFlBQVcsRUFBSTtBQUNmLElBQUEsQ0FBRyxHQUFDO0FBQ0osSUFBQSxDQUFHLE9BQUs7QUFDUixJQUFBLENBQUcsTUFBSTtBQUNQLElBQUEsQ0FBRyxNQUFJO0FBQ1AsS0FBQyxDQUFHLE1BQUk7QUFDUixJQUFBLENBQUcsS0FBRztBQUNOLElBQUEsQ0FBRyxNQUFJO0FBQ1AsS0FBQyxDQUFHLE1BQUk7QUFBQSxFQUNaLENBQUM7QUFFRCxBQUFJLElBQUEsQ0FBQSxNQUFLLEVBQUksVUFBVSxLQUFJLENBQUc7QUFDMUIsQUFBSSxNQUFBLENBQUEsRUFBQyxFQUFJLFVBQVUsR0FBRSxDQUFHO0FBQ3BCLFFBQUUsRUFBSSxDQUFBLEdBQUUsS0FBSyxBQUFDLEVBQUMsQ0FBQztBQUNoQixTQUFJLENBQUMsR0FBRSxPQUFPLEVBQUksRUFBQSxDQUFDLEdBQ2YsRUFBQyxDQUFDLEdBQUUsQ0FBRSxDQUFBLENBQUMsSUFBTSxJQUFFLENBQUEsRUFBSyxDQUFBLEdBQUUsQ0FBRSxHQUFFLE9BQU8sRUFBSSxFQUFBLENBQUMsSUFBTSxJQUFFLENBQUMsR0FDL0MsRUFBQyxHQUFFLENBQUUsQ0FBQSxDQUFDLElBQU0sSUFBRSxDQUFBLEVBQUssQ0FBQSxHQUFFLENBQUUsR0FBRSxPQUFPLEVBQUksRUFBQSxDQUFDLElBQU0sSUFBRSxDQUFDLENBQUEsRUFDOUMsRUFBQyxHQUFFLENBQUUsQ0FBQSxDQUFDLElBQU0sSUFBRSxDQUFBLEVBQUssQ0FBQSxHQUFFLENBQUUsR0FBRSxPQUFPLEVBQUksRUFBQSxDQUFDLElBQU0sSUFBRSxDQUFDLENBQUEsRUFDOUMsRUFBQyxHQUFFLENBQUUsQ0FBQSxDQUFDLElBQU0sSUFBRSxDQUFBLEVBQUssQ0FBQSxHQUFFLENBQUUsR0FBRSxPQUFPLEVBQUksRUFBQSxDQUFDLElBQU0sSUFBRSxDQUFDLENBQUMsQ0FBRztBQUNsRCxVQUFJO0FBQ0EsZUFBTyxDQUFBLElBQUcsTUFBTSxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUM7UUFDMUIsQ0FDQSxPQUFPLENBQUEsQ0FBRztBQUNOLFVBQUEsS0FBSyxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUM7UUFDYjtBQUFBLE1BQ0o7QUFBQSxBQUNBLFdBQU8sTUFBSSxDQUFDO0lBQ2hCLENBQUM7QUFFRCxPQUFJLENBQUEsU0FBUyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUc7QUFDbkIsQUFBSSxRQUFBLENBQUEsTUFBSyxFQUFJLENBQUEsRUFBQyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUM7QUFDdEIsU0FBSSxNQUFLLElBQU0sTUFBSSxDQUFHO0FBQ2xCLGFBQUssRUFBSSxDQUFBLEVBQUMsQUFBQyxDQUFDLGtCQUFpQixBQUFDLENBQUMsS0FBSSxDQUFDLENBQUMsQ0FBQztNQUMxQztBQUFBLEFBQ0EsU0FBSSxNQUFLLElBQU0sTUFBSSxDQUFHO0FBQ2xCLGFBQU8sTUFBSSxDQUFDO01BQ2hCO0FBQUEsQUFDQSxXQUFPLE9BQUssQ0FBQztJQUNqQjtBQUFBLEFBQ0EsU0FBTyxNQUFJLENBQUM7RUFDaEIsQ0FBQztBQUVELFNBQVMsT0FBSyxDQUFFLEtBQUksQ0FBRyxDQUFBLEdBQUUsQ0FBRyxDQUFBLEdBQUUsQ0FBRztBQUM3QixPQUFJLENBQUMsS0FBSSxDQUFHO0FBQ1IsWUFBTTtJQUNWO0FBQUEsQUFDQSxPQUFJLENBQUEsUUFBUSxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUEsRUFBSyxDQUFBLENBQUEsY0FBYyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUc7QUFDNUMsTUFBQSxRQUFRLEFBQUMsQ0FBQyxLQUFJLENBQUcsT0FBSyxDQUFDLENBQUM7SUFDNUIsS0FDSyxLQUFJLENBQUEsU0FBUyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUc7QUFDeEIsU0FBSSxHQUFFLElBQU0sU0FBTyxDQUFHO0FBQ2xCLEFBQUksVUFBQSxDQUFBLENBQUEsRUFBSSxDQUFBLEtBQUksTUFBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDL0IsV0FBSSxDQUFBLENBQUc7QUFDSCxBQUFJLFlBQUEsQ0FBQSxXQUFNLENBQUM7QUFDWCxhQUFJLEdBQUUsU0FBUyxDQUFHO0FBQ2QsWUFBQSxDQUFFLENBQUEsQ0FBQyxFQUFJLENBQUEsR0FBRSxTQUFTLENBQUM7QUFDbkIsaUJBQU8sSUFBRSxTQUFTLENBQUM7VUFDdkI7QUFBQSxBQUNBLFlBQUUsQ0FBRSxHQUFFLENBQUMsRUFBSSxJQUFJLE9BQUssQUFBQyxDQUFDLENBQUEsQ0FBRSxDQUFBLENBQUMsQ0FBRyxDQUFBLENBQUEsQ0FBRSxDQUFBLENBQUMsQ0FBQyxDQUFDO1FBQ3JDO0FBQUEsTUFDSixLQUNLO0FBQ0QsQUFBSSxVQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsTUFBSyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUM7QUFDM0IsV0FBSSxPQUFNLElBQU0sTUFBSSxDQUFHO0FBQ25CLFlBQUUsQ0FBRSxHQUFFLENBQUMsRUFBSSxRQUFNLENBQUM7QUFDbEIsZUFBSyxBQUFDLENBQUMsT0FBTSxDQUFHLElBQUUsQ0FBRyxJQUFFLENBQUMsQ0FBQztRQUM3QjtBQUFBLE1BQ0o7QUFBQSxJQUNKO0FBQUEsRUFDSjtBQUFBLEFBRUEsZ0JBQWdCLE1BQUksQ0FBRztBQUNuQixPQUFJLEtBQUksZUFBZSxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUc7QUFDM0IsYUFBUSxHQUFFO0FBQ04sV0FBSSxFQUFDLEdBQUUsQ0FBQztBQUNKLHFCQUFXLEVBQUUsRUFBSSxDQUFBLE1BQUssQUFBQyxDQUFDLEtBQUksQ0FBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ25DLFVBQUEsS0FBSyxBQUFDLENBQUMsWUFBVyxFQUFFLENBQUcsT0FBSyxDQUFDLENBQUM7QUFDOUIsZUFBSztBQUFBLEFBQ1QsV0FBSSxFQUFDLEdBQUUsQ0FBQztBQUNKLHFCQUFXLEVBQUUsRUFBSSxDQUFBLEtBQUksQ0FBRSxHQUFFLENBQUMsQ0FBQztBQUMzQixlQUFLO0FBQUEsQUFDVCxXQUFJLEVBQUMsR0FBRSxDQUFDO0FBQ0oscUJBQVcsRUFBRSxFQUFJLENBQUEsTUFBSyxBQUFDLENBQUMsS0FBSSxDQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFDbkMsZUFBSztBQUFBLEFBQ1QsV0FBSSxFQUFDLEdBQUUsQ0FBQztBQUNKLHFCQUFXLEVBQUUsRUFBSSxDQUFBLE1BQUssQUFBQyxDQUFDLEtBQUksQ0FBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ25DLGVBQUs7QUFBQSxBQUNULFdBQUksRUFBQyxJQUFHLENBQUM7QUFDTCxxQkFBVyxHQUFHLEVBQUksQ0FBQSxRQUFPLEFBQUMsQ0FBQyxLQUFJLENBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQztBQUN0QyxlQUFLO0FBQUEsQUFDVCxXQUFJLEVBQUMsR0FBRSxDQUFDO0FBQ0oscUJBQVcsRUFBRSxFQUFJLENBQUEsUUFBTyxBQUFDLENBQUMsS0FBSSxDQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFDckMsZUFBSztBQUFBLEFBQ1QsV0FBSSxFQUFDLEdBQUUsQ0FBQztBQUNKLHFCQUFXLEVBQUUsRUFBSSxDQUFBLE1BQUssQUFBQyxDQUFDLEtBQUksQ0FBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ25DLGVBQUs7QUFBQSxBQUNULFdBQUksRUFBQyxJQUFHLENBQUM7QUFDTCxxQkFBVyxHQUFHLEVBQUksQ0FBQSxDQUFDLENBQUEsU0FBUyxBQUFDLENBQUMsS0FBSSxDQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUEsRUFBSyxDQUFBLEtBQUksQ0FBRSxHQUFFLENBQUMsSUFBTSxPQUFLLENBQUMsR0FBSyxFQUFDLENBQUEsVUFBVSxBQUFDLENBQUMsS0FBSSxDQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUEsRUFBSyxDQUFBLEtBQUksQ0FBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzlHLGVBQUs7QUFBQSxNQUNiO0lBQ0o7QUFBQSxFQUNKO0FBQUEsQUFDQSxPQUFPLGFBQVcsQ0FBQztBQUN2QixDQUFDO0FBRUQsQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLFVBQVUsS0FBSSxDQUFHLENBQUEsS0FBSSxDQUFHLENBQUEsT0FBTSxDQUFHLENBQUEsUUFBTyxDQUFHO0FBQ3JELE1BQUksQUFBQyxDQUFDLFdBQVUsQ0FBRyxNQUFJLENBQUMsQ0FBQztBQUN6QixBQUFJLElBQUEsQ0FBQSxXQUFVLEVBQUksQ0FBQSxVQUFTLEFBQUMsQ0FBQyxLQUFJLENBQUcsUUFBTSxDQUFDLENBQUM7QUFDNUMsS0FBSSxDQUFDLEtBQUk7QUFBRSxTQUFPLFlBQVUsQ0FBQztBQUFBLEFBQzdCLE1BQUksQUFBQyxDQUFDLGlCQUFnQixDQUFHLE1BQUksQ0FBQyxDQUFDO0FBQy9CLEFBQUksSUFBQSxDQUFBLGFBQVksRUFBSSxNQUFJLENBQUM7QUFDekIsQUFBSSxJQUFBLENBQUEsYUFBWSxFQUFJLE1BQUksQ0FBQztBQUV6QixBQUFJLElBQUEsQ0FBQSxPQUFNLEVBQUksTUFBSSxDQUFDO0FBQ25CLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxNQUFJLENBQUM7QUFFaEIsU0FBUSxXQUFVLEVBQUU7QUFDaEIsT0FBSyxPQUFLLENBQUM7QUFDWCxPQUFLLFFBQU0sQ0FBQztBQUNaLE9BQUssV0FBUztBQUNWLFlBQU0sRUFBSSxLQUFHLENBQUM7QUFDZCxrQkFBWSxFQUFJLENBQUEsYUFBWSxLQUFLLEFBQUMsQ0FBQyxXQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQ2pELGtCQUFZLEVBQUksQ0FBQSxhQUFZLEtBQUssQUFBQyxDQUFDLFdBQVUsRUFBRSxDQUFDLENBQUM7QUFDakQsV0FBSztBQUFBLEFBQ1QsT0FBSyxZQUFVLENBQUM7QUFDaEIsT0FBSyxPQUFLO0FBQ04sWUFBTSxFQUFJLEtBQUcsQ0FBQztBQUNkLGtCQUFZLEVBQUksQ0FBQSxhQUFZLFVBQVUsQUFBQyxDQUFDLFdBQVUsRUFBRSxDQUFDLENBQUM7QUFDdEQsa0JBQVksRUFBSSxDQUFBLGFBQVksVUFBVSxBQUFDLENBQUMsV0FBVSxFQUFFLENBQUMsQ0FBQztBQUN0RCxXQUFLO0FBQUEsQUFDVDtBQUNJLFVBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQyw2QkFBNEIsRUFBSSxDQUFBLFdBQVUsRUFBRSxDQUFBLENBQUksS0FBRyxDQUFDLENBQUM7QUFEbEUsRUFFWDtBQUVBLEtBQUksQ0FBQyxJQUFHLENBQUc7QUFDUCxPQUFJLFdBQVUsRUFBRSxJQUFNLFdBQVMsQ0FBRztBQUM5QixrQkFBWSxFQUFJLENBQUEsYUFBWSxTQUFTLEFBQUMsQ0FBQyxXQUFVLEVBQUUsQ0FBQyxDQUFDO0lBQ3pEO0FBQUEsQUFDQSxPQUFJLFdBQVUsRUFBRTtBQUFHLGtCQUFZLEVBQUksQ0FBQSxhQUFZLEtBQUssQUFBQyxDQUFDLFdBQVUsRUFBRSxDQUFDLENBQUM7QUFBQSxBQUNwRSxPQUFJLFdBQVUsR0FBRztBQUFHLGtCQUFZLEVBQUksQ0FBQSxhQUFZLEtBQUssQUFBQyxDQUFDLFdBQVUsR0FBRyxDQUFDLENBQUM7QUFBQSxBQUN0RSxPQUFJLFdBQVUsRUFBRTtBQUFHLGtCQUFZLEVBQUksQ0FBQSxhQUFZLE1BQU0sQUFBQyxDQUFDLFdBQVUsRUFBRSxDQUFDLENBQUM7QUFBQSxBQUNyRSxPQUFJLFdBQVUsRUFBRSxHQUFLLENBQUEsV0FBVSxFQUFFLElBQU0sT0FBSztBQUFHLGtCQUFZLEVBQUksQ0FBQSxhQUFZLE9BQU8sQUFBQyxDQUFDLFdBQVUsRUFBRSxDQUFDLENBQUM7QUFBQSxBQUNsRyxPQUFJLFdBQVUsRUFBRTtBQUFHLGtCQUFZLEVBQUksQ0FBQSxhQUFZLFNBQVMsQUFBQyxDQUFDLFdBQVUsRUFBRSxDQUFDLENBQUM7QUFBQSxBQUN4RSxPQUFJLFdBQVUsRUFBRSxJQUFNLFFBQU0sQ0FBRztBQUMzQixrQkFBWSxFQUFJLENBQUEsYUFBWSxNQUFNLEFBQUMsRUFBQyxDQUFDO0lBQ3pDO0FBQUEsRUFDSixLQUNLO0FBQ0QsT0FBSSxXQUFVLEVBQUU7QUFBRyxrQkFBWSxFQUFJLENBQUEsYUFBWSxLQUFLLEFBQUMsQ0FBQyxXQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQUEsQUFDcEUsT0FBSSxXQUFVLEdBQUc7QUFBRyxrQkFBWSxFQUFJLENBQUEsYUFBWSxLQUFLLEFBQUMsQ0FBQyxXQUFVLEdBQUcsQ0FBQyxDQUFDO0FBQUEsQUFDdEUsT0FBSSxXQUFVLEVBQUU7QUFBRyxrQkFBWSxFQUFJLENBQUEsYUFBWSxNQUFNLEFBQUMsQ0FBQyxXQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQUEsQUFDckUsT0FBSSxXQUFVLEVBQUU7QUFBRyxrQkFBWSxFQUFJLENBQUEsYUFBWSxRQUFRLEFBQUMsQ0FBQyxXQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQUEsQUFDdkUsT0FBSSxXQUFVLEVBQUUsQ0FBRztBQUNmLFVBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQywrQ0FBOEMsQ0FBQyxDQUFDO0lBQ3BFO0FBQUEsRUFDSjtBQUFBLEFBRUEsS0FBSSxXQUFVLEdBQUcsQ0FBRztBQUNoQixPQUFJLENBQUMsT0FBTSxDQUFHO0FBQ1YsVUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLGlEQUFnRCxFQUFJLENBQUEsV0FBVSxFQUFFLENBQUEsQ0FBSSxLQUFHLENBQUMsQ0FBQztJQUM3RjtBQUFBLEFBRUEsZ0JBQVksRUFBSSxJQUFJLGtCQUFnQixBQUFDLENBQUMsYUFBWSxDQUFHLGNBQVksQ0FBRyxLQUFHLENBQUMsQ0FBQztFQUM3RTtBQUFBLEFBRUEsT0FBTyxjQUFZLENBQUM7QUFDeEIsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLFNBQVMsTUFBSSxDQUFFLE1BQUssQ0FBRyxDQUFBLE9BQU0sQ0FBRztBQUM3QyxPQUFLLFFBQVEsTUFBTSxFQUFJLENBQUEsTUFBSyxRQUFRLE1BQU0sRUFBSSxVQUFVLEtBQUksQ0FBRztBQUMzRCxVQUFNLEVBQUksQ0FBQSxPQUFNLEdBQUssR0FBQyxDQUFDO0FBQ3ZCLFNBQU8sQ0FBQSxPQUFNLEFBQUMsQ0FBQyxLQUFJLENBQUcsS0FBRyxDQUFHLFFBQU0sQ0FBQyxDQUFDO0VBQ3hDLENBQUM7QUFDTCxDQUFDO0FBQ0QiLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5sZXQgSW5saW5lQ291bnRSZXN1bHQgPSByZXF1aXJlKFwiLi9pbmxpbmVDb3VudFJlc3VsdFwiKTtcclxubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwibW9kYXRhOnF1ZXJ5XCIpO1xyXG5cclxubGV0IHBhcnNlUXVlcnkgPSBmdW5jdGlvbiAocXVlcnksIG9wdGlvbnMpIHtcclxuICAgIGxldCBkZWNvZGVkUXVlcnkgPSB7XHJcbiAgICAgICAgcToge30sICAgICAgLy8gIHF1ZXJ5XHJcbiAgICAgICAgdDogXCJmaW5kXCIsICAgLy8gIGNvdW50XHJcbiAgICAgICAgZjogZmFsc2UsICAgICAgLy8gZmllbGRzXHJcbiAgICAgICAgczogZmFsc2UsICAgICAgLy8gIHNvcnRcclxuICAgICAgICBzazogZmFsc2UsICAgICAgLy8gIHNraXBcclxuICAgICAgICBsOiBudWxsLCAgICAgLy8gIGxpbWl0XHJcbiAgICAgICAgcDogZmFsc2UsICAgIC8vcG9wdWxhdGVcclxuICAgICAgICBpYzogZmFsc2VcclxuICAgIH07XHJcblxyXG4gICAgbGV0IGRlY29kZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgIGxldCB0byA9IGZ1bmN0aW9uIChzdHIpIHtcclxuICAgICAgICAgICAgc3RyID0gc3RyLnRyaW0oKTtcclxuICAgICAgICAgICAgaWYgKChzdHIubGVuZ3RoID4gMSkgJiZcclxuICAgICAgICAgICAgICAgICgoc3RyWzBdID09PSBcIntcIiAmJiBzdHJbc3RyLmxlbmd0aCAtIDFdID09PSBcIn1cIikgfHxcclxuICAgICAgICAgICAgICAgIChzdHJbMF0gPT09IFwiJ1wiICYmIHN0cltzdHIubGVuZ3RoIC0gMV0gPT09IFwiJ1wiKSB8fFxyXG4gICAgICAgICAgICAgICAgKHN0clswXSA9PT0gJ1wiJyAmJiBzdHJbc3RyLmxlbmd0aCAtIDFdID09PSAnXCInKSB8fFxyXG4gICAgICAgICAgICAgICAgKHN0clswXSA9PT0gXCJbXCIgJiYgc3RyW3N0ci5sZW5ndGggLSAxXSA9PT0gXCJdXCIpKSkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzdHIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBfLm5vb3AoZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xyXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gdG8odmFsdWUpO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gdG8oZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHdhbGtlcih2YWx1ZSwga2V5LCBvYmopIHtcclxuICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkgfHwgXy5pc1BsYWluT2JqZWN0KHZhbHVlKSkge1xyXG4gICAgICAgICAgICBfLmZvckVhY2godmFsdWUsIHdhbGtlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKF8uaXNTdHJpbmcodmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGlmIChrZXkgPT09IFwiJHJlZ2V4XCIpIHtcclxuICAgICAgICAgICAgICAgIGxldCBtID0gdmFsdWUubWF0Y2goL1xcLyguKilcXC8vKTtcclxuICAgICAgICAgICAgICAgIGlmIChtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai4kb3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtWzJdID0gb2JqLiRvcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb2JqLiRvcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IG5ldyBSZWdFeHAobVsxXSwgbVsyXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGVjb2RlZCA9IGRlY29kZSh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoZGVjb2RlZCAhPT0gdmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBvYmpba2V5XSA9IGRlY29kZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyKGRlY29kZWQsIGtleSwgb2JqKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGxldCBrZXkgaW4gcXVlcnkpIHtcclxuICAgICAgICBpZiAocXVlcnkuaGFzT3duUHJvcGVydHkoa2V5KSkge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGtleSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZShcInFcIik6XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZFF1ZXJ5LnEgPSBkZWNvZGUocXVlcnlba2V5XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGRlY29kZWRRdWVyeS5xLCB3YWxrZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcInRcIik6XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZFF1ZXJ5LnQgPSBxdWVyeVtrZXldO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZShcImZcIik6XHJcbiAgICAgICAgICAgICAgICAgICAgZGVjb2RlZFF1ZXJ5LmYgPSBkZWNvZGUocXVlcnlba2V5XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlKFwic1wiKTpcclxuICAgICAgICAgICAgICAgICAgICBkZWNvZGVkUXVlcnkucyA9IGRlY29kZShxdWVyeVtrZXldKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UoXCJza1wiKTpcclxuICAgICAgICAgICAgICAgICAgICBkZWNvZGVkUXVlcnkuc2sgPSBwYXJzZUludChxdWVyeVtrZXldKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UoXCJsXCIpOlxyXG4gICAgICAgICAgICAgICAgICAgIGRlY29kZWRRdWVyeS5sID0gcGFyc2VJbnQocXVlcnlba2V5XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlKFwicFwiKTpcclxuICAgICAgICAgICAgICAgICAgICBkZWNvZGVkUXVlcnkucCA9IGRlY29kZShxdWVyeVtrZXldKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UoXCJpY1wiKTpcclxuICAgICAgICAgICAgICAgICAgICBkZWNvZGVkUXVlcnkuaWMgPSAoXy5pc1N0cmluZyhxdWVyeVtrZXldKSAmJiBxdWVyeVtrZXldID09PSBcInRydWVcIikgfHwgKF8uaXNCb29sZWFuKHF1ZXJ5W2tleV0pICYmIHF1ZXJ5W2tleV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRlY29kZWRRdWVyeTtcclxufTtcclxuXHJcbmxldCBkb1F1ZXJ5ID0gZnVuY3Rpb24gKHF1ZXJ5LCBtb2RlbCwgb3B0aW9ucywgY2FsbGJhY2spIHtcclxuICAgIGRlYnVnKFwicXVlcnk6ICVqXCIsIHF1ZXJ5KTtcclxuICAgIGxldCBwYXJzZWRRdWVyeSA9IHBhcnNlUXVlcnkocXVlcnksIG9wdGlvbnMpO1xyXG4gICAgaWYgKCFtb2RlbClyZXR1cm4gcGFyc2VkUXVlcnk7XHJcbiAgICBkZWJ1ZyhcInBhcnNlZFF1ZXJ5OiAlalwiLCBxdWVyeSk7XHJcbiAgICBsZXQgbW9uZ29vc2VRdWVyeSA9IG1vZGVsO1xyXG4gICAgbGV0IG9yaWdpbmFsUXVlcnkgPSBtb2RlbDtcclxuXHJcbiAgICBsZXQgY2FuRG9JQyA9IGZhbHNlO1xyXG4gICAgbGV0IGFnZ3IgPSBmYWxzZTtcclxuXHJcbiAgICBzd2l0Y2ggKHBhcnNlZFF1ZXJ5LnQpIHtcclxuICAgICAgICBjYXNlIFwiZmluZFwiOlxyXG4gICAgICAgIGNhc2UgXCJjb3VudFwiOlxyXG4gICAgICAgIGNhc2UgXCJkaXN0aW5jdFwiOlxyXG4gICAgICAgICAgICBjYW5Eb0lDID0gdHJ1ZTtcclxuICAgICAgICAgICAgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuZmluZChwYXJzZWRRdWVyeS5xKTtcclxuICAgICAgICAgICAgb3JpZ2luYWxRdWVyeSA9IG9yaWdpbmFsUXVlcnkuZmluZChwYXJzZWRRdWVyeS5xKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcImFnZ3JlZ2F0ZVwiOlxyXG4gICAgICAgIGNhc2UgXCJhZ2dyXCI6XHJcbiAgICAgICAgICAgIGNhbkRvSUMgPSB0cnVlO1xyXG4gICAgICAgICAgICBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5hZ2dyZWdhdGUocGFyc2VkUXVlcnkucSk7XHJcbiAgICAgICAgICAgIG9yaWdpbmFsUXVlcnkgPSBvcmlnaW5hbFF1ZXJ5LmFnZ3JlZ2F0ZShwYXJzZWRRdWVyeS5xKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm90IHN1cHBvcnRlZCBxdWVyeSB0eXBlOiAnXCIgKyBwYXJzZWRRdWVyeS50ICsgXCInLlwiKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWFnZ3IpIHtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkudCA9PT0gXCJkaXN0aW5jdFwiKSB7XHJcbiAgICAgICAgICAgIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LmRpc3RpbmN0KHBhcnNlZFF1ZXJ5LmYpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkucykgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuc29ydChwYXJzZWRRdWVyeS5zKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkuc2spIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LnNraXAocGFyc2VkUXVlcnkuc2spO1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS5sKSBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5saW1pdChwYXJzZWRRdWVyeS5sKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkuZiAmJiBwYXJzZWRRdWVyeS50ID09PSBcImZpbmRcIikgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkuc2VsZWN0KHBhcnNlZFF1ZXJ5LmYpO1xyXG4gICAgICAgIGlmIChwYXJzZWRRdWVyeS5wKSBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5wb3B1bGF0ZShwYXJzZWRRdWVyeS5wKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkudCA9PT0gXCJjb3VudFwiKSB7XHJcbiAgICAgICAgICAgIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LmNvdW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgaWYgKHBhcnNlZFF1ZXJ5LnMpIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LnNvcnQocGFyc2VkUXVlcnkucyk7XHJcbiAgICAgICAgaWYgKHBhcnNlZFF1ZXJ5LnNrKSBtb25nb29zZVF1ZXJ5ID0gbW9uZ29vc2VRdWVyeS5za2lwKHBhcnNlZFF1ZXJ5LnNrKTtcclxuICAgICAgICBpZiAocGFyc2VkUXVlcnkubCkgbW9uZ29vc2VRdWVyeSA9IG1vbmdvb3NlUXVlcnkubGltaXQocGFyc2VkUXVlcnkubCk7XHJcbiAgICAgICAgaWYgKHBhcnNlZFF1ZXJ5LmYpIG1vbmdvb3NlUXVlcnkgPSBtb25nb29zZVF1ZXJ5LnByb2plY3QocGFyc2VkUXVlcnkuZik7XHJcbiAgICAgICAgaWYgKHBhcnNlZFF1ZXJ5LnApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUG9wdWxhdGUgaXMgbm90IHN1cHBvcnRlZCBkdXJpbmcgYWdncmVnYXRpb24uXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAocGFyc2VkUXVlcnkuaWMpIHtcclxuICAgICAgICBpZiAoIWNhbkRvSUMpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW5saW5lIGNvdW50IGlzIG5vdCBzdXBwb3J0ZWQgZm9yIHF1ZXJ5IHR5cGU6ICdcIiArIHBhcnNlZFF1ZXJ5LnQgKyBcIicuXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBEbyBpbmxpbmUgY291bnQ6XHJcbiAgICAgICAgbW9uZ29vc2VRdWVyeSA9IG5ldyBJbmxpbmVDb3VudFJlc3VsdChvcmlnaW5hbFF1ZXJ5LCBtb25nb29zZVF1ZXJ5LCBhZ2dyKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbW9uZ29vc2VRdWVyeTtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gUXVlcnkoc2NoZW1hLCBvcHRpb25zKSB7XHJcbiAgICBzY2hlbWEuc3RhdGljcy5xdWVyeSA9IHNjaGVtYS5zdGF0aWNzLlF1ZXJ5ID0gZnVuY3Rpb24gKHF1ZXJ5KSB7XHJcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XHJcbiAgICAgICAgcmV0dXJuIGRvUXVlcnkocXVlcnksIHRoaXMsIG9wdGlvbnMpO1xyXG4gICAgfTtcclxufTtcclxuIl19
