{"version":3,"names":[],"mappings":"","sources":["index.js"],"sourcesContent":["\"use strict\";\n/*global it,describe,before*/\nlet fs = require(\"fs\");\nlet mongoose = require(\"mongoose\");\nlet Schema = mongoose.Schema;\nlet assert = require(\"chai\").assert;\nlet Query = require(\"../../\").Query;\n\nlet ObjectId = Schema.ObjectId;\n\nlet OrigSchema = new mongoose.Schema({\n    value: { type: String, default: \"original\" }\n});\nlet TestSchema = new mongoose.Schema({\n    title: { type: String, index: true },\n    msg: { type: String, lowercase: true, trim: true },\n    date: { type: Date, default: Date.now },\n    orig: { type: ObjectId, ref: \"originals\" },\n    nest: {\n        ed: { type: String, default: \"value\" }\n    }\n});\nTestSchema.plugin(Query);\nlet origModel = mongoose.model(\"originals\", OrigSchema);\nlet Test = mongoose.model(\"test\", TestSchema);\n\n\nmongoose.connect(process.env.MONGO_URL, {});\nlet _id = \"123123\";\n\ndescribe('Query:basic', function () {\n    before(function (done) {\n        this.timeout(10000);\n\n        var create = function (i, max, callback) {\n            if (i < max) {\n                var obj = new Test({ title: (i < 10 ? 'testa' : 'testb'), msg: 'i#' + i, orig: _id });\n                obj.save(function (error, doc) {\n                    create(i + 1, max, callback);\n                });\n            } else {\n                callback();\n            }\n        }\n        mongoose.connection.on('connected', function () {\n            origModel.remove({}, function () {\n                var obj = new origModel();\n                obj.save(function (error, doc) {\n                    _id = doc._id;\n\n                    Test.remove({}, function () {\n                        create(0, 20, done);\n                    });\n                });\n            });\n        });\n    });\n\n    it('all', function (done) {\n        Test.Query({ q: '{}' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 20);\n            assert.isTrue((data[0].orig + '').match(/([0-9a-z]{24})/) != null);\n            done();\n        });\n    });\n    it('regex', function (done) {\n        Test.Query({ q: '{\"title\": {\"$regex\": \"/^testa/\"}}' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 10);\n            assert.isTrue((data[0].orig + '').match(/([0-9a-z]{24})/) != null);\n            done();\n        });\n    });\n    it('regex && ic', function (done) {\n        Test.Query({ q: '{\"title\": {\"$regex\": \"/^testa/\"}}', ic: true, sk: 2 }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.count, 10);\n            assert.equal(data.data.length, 8);\n            assert.isTrue((data.data[0].orig + '').match(/([0-9a-z]{24})/) != null);\n            done();\n        });\n    });\n    it('find & sort', function (done) {\n        Test.Query({ q: '{}', t: 'find', s: '{\"msg\": 1}', l: 1 }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.typeOf(data, 'Array');\n            assert.equal(data[0].title, 'testa');\n            assert.equal(data[0].msg, 'i#0');\n            assert.equal(data.length, 1);\n            done();\n        });\n    });\n    it('exact', function (done) {\n        Test.Query({ q: '{\"msg\":\"i#3\"}' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 1);\n            assert.equal(data[0].msg, \"i#3\");\n            done();\n        });\n    });\n    it('populate', function (done) {\n        Test.Query({ q: '{\"msg\":\"i#3\"}', p: 'orig' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 1);\n            assert.equal(data[0].msg, \"i#3\");\n            assert.equal(data[0].orig.value, \"original\");\n            done();\n        });\n    });\n    it('limit & select', function (done) {\n        Test.Query({ q: '{}', f: 'title', l: '3', s: '{\"title\": -1}' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 3);\n            assert.equal(data[0].msg, undefined);\n            assert.equal(data[0].title, \"testb\");\n            assert.equal(data[1].msg, undefined);\n            assert.equal(data[1].title, \"testb\");\n            assert.equal(data[2].msg, undefined);\n            assert.equal(data[2].title, \"testb\");\n            done();\n        });\n    });\n\n    it('skip', function (done) {\n        Test.Query({ q: '{}', sk: '3' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 17);\n            done();\n        });\n    });\n\n    it('count', function (done) {\n        Test.Query({ q: '{\"$or\": [ {\"msg\":\"i#1\"}, {\"msg\":\"i#2\"}]}', t: 'count' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data, 2);\n            done();\n        });\n    });\n\n    it('distinct', function (done) {\n        Test.Query({ f: 'title', t: 'distinct' }).exec(function (error, data) {\n            assert.equal(error, undefined);\n            assert.equal(data.length, 2);\n\n            done();\n        });\n    });\n});"],"file":"index.js","sourceRoot":"/source/"}